---
title: "Dairy Comp"
author: "Srikanth Aravamuthan and Emil Walleser"
date: "7/11/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(readxl)
library(glue)
library(forcats)
library(lubridate)


```

```{r}


# user changes

#set this to directory where this file and excel files are located
wd = "~/XXX/XXX"

#set date from dairycomp extraction
dairy_comp_extraction_date = lubridate::date("2022-08-09")

output_file_header = 'XXXX_farm_name'

#set and print wd
setwd(wd)
getwd()


df_start <- read_csv(file = "XXX.CSV",guess_max = 100000)
problems(df_start)


```
column names assumed to be in the dataset are:

ID,LACT,LCTGP,	FDAT,BDAT,FCDAT,RC,DRYLG,DDRY,PDCC,PDIM,EASE,CNUM,	CLIVE,CSEX,FTDIM, 	FSTPJ,
FSTBF,	FSTPR,	PEAKM, 	DCAR,	PR305,	LOG1,	Event,Date, Remark,Protocols,Technician,       

Confirm these item names match EXACTLY the ones in your data. Use the rename function to change variable names to match
use select to drop any unneeded additional variables. Can also create placeholder variables if they are not found in data for some reason.

```{r}
check_cols <- c("ID","LACT","LCTGP","FDAT","BDAT","FCDAT","RC","DRYLG","DDRY",
                "PDCC","PDIM","EASE","CNUM","CLIVE","CSEX","FTDIM","FSTPJ","FSTBF",
                "FSTPR","PEAKM","DCAR",	"PR305","LOG1",	"Event","Date", "Remark","Protocols","Technician")       

event_names <-df_start%>% select(Event) %>% unique()

event_names

col_names <- df_start %>% names()


print("columns missing")
setdiff(check_cols,col_names)

print("extra columns")
setdiff(col_names,check_cols)
```

# ENSURE THIS is correct for your data 
```{r}


### renaming variables to match standardized inputs

# df_start <- df_start %>%
#   rename(FDAT = FDAT)

### generate an empty placeholder columns
### add additional variables as necessary

#df_start <- df_start %>% mutate(PR305 = NA)


### drop additional variables that are not needed

#df_start <- df_start %>% select(-EXAMPLE_COL)


col_names <- df_start %>% names()
print("columns missing")
setdiff(check_cols,col_names)

print("extra columns")
setdiff(col_names,check_cols)

```

# What events exist for this dairy

```{r}
df_start %>% select(Event) %>% arrange() %>% table() 
```

#check that the names of events match the appropriate value for 

```{r}
df.wide <-  df_start %>% 
  mutate(Event=case_when(Event == 'FRESH' ~ 'FRESH',
                         Event == 'ABORT' ~ 'ABORT',
                         Event == 'SOLD' ~ 'SOLD',
                         Event == 'DIED' ~ 'DIED',
                         Event == 'MF' ~ 'MF',
                         Event == 'RP' ~ 'RP',
                         Event == 'METR' ~ 'METR',
                         Event == 'KETOSIS' ~ 'KETOSIS',
                         Event == 'DA' ~ 'DA',
                         Event == 'PNEU' ~ 'PNEU',
                         Event == 'SCOURS' ~ 'DIARHEA',
                         Event == 'LAME' ~ 'LAME',
                         Event == 'FOOTRIM' ~ 'FOOTRIM',
                         Event == 'ILLMISC' ~ 'ILLMISC',
                         Event == 'MAST' ~ 'MAST',
                         TRUE ~ Event)) %>% 
  filter(Event != 'NA') %>%
  
  #appending protocol info to event info
  unite(col=Remark,Remark,Protocols,sep = '_')%>% # this line combines columns remark and protocols as dairy uses this 
  group_by(ID, LACT, Event) %>% 
  # append event number
  mutate(Event = glue("{Event}_{row_number()}")) %>% 
  ungroup() %>% 
  #select(-Technician,) %>% 
  # pivot data from wide to long by date and remark
  pivot_longer(Date:Remark) %>% 
  # append event description
  mutate(name = glue("{Event}_{name}")) %>% 
  select(-Event) %>% 
  # rowwise steps can be moved here
  # pivot data from long to wide by event name
  pivot_wider(id_cols = ID:LOG1, names_from  = name, values_from = value) %>% 
  mutate_at(vars(ends_with("_Date")), lubridate::mdy) %>% 
  mutate_at(vars(ends_with("_Remark")), as.character) %>%
  #drop
  filter(!is.na(FRESH)) %>%
  filter(LACT > 0) %>% 
  write_csv(paste(output_file_header,'wide.csv',sep = '_'))

```

```{r}
sum_df<- 
  read_csv(paste(output_file_header,'wide.csv',sep = '_'), guess_max = 1000000) %>% 
  mutate_at(vars(ends_with("_Date")), lubridate::date) %>%
  mutate_at(vars(ends_with("_Remark")), as.character) %>%
  # rowwise count of all events
  rowwise() %>% 
  mutate(XMF = sum(!is.na(c_across(starts_with("MF_") & ends_with("_Date")))),
         XRP = sum(!is.na(c_across(starts_with("RP_") & ends_with("_Date")))),
         XMETR = sum(!is.na(c_across(starts_with("METR_") & ends_with("_Date")))),
         XKET = sum(!is.na(c_across(starts_with("KETOSIS_") & ends_with("_Date")))),
         XDA = sum(!is.na(c_across(starts_with("DA_") & ends_with("_Date")))),
         XPNEU = sum(!is.na(c_across(starts_with("PNEU_") & ends_with("_Date")))),
         XDIAR = sum(!is.na(c_across(starts_with("DIARHEA_") & ends_with("_Date")))),
         XFTRM = sum(!is.na(c_across(starts_with("FOOTRIM_") & ends_with("_Date")))),
         XLAME = sum(!is.na(c_across(starts_with("LAME_") & ends_with("_Date")))),
         XMAST = sum(!is.na(c_across(starts_with("MAST_") & ends_with("_Date")))),
         XILL = sum(!is.na(c_across(starts_with("ILLMISC_") & ends_with("_Date")))))
         
```

```{r}
sum_df %>% names()
```
```{r}
comp_df <- sum_df %>%  
  ungroup() %>% 
  mutate(
    DATS = SOLD_1_Date,
    REMS = SOLD_1_Remark,
    DATD = DIED_1_Date,
    REMD = DIED_1_Remark,
    DATR = 
      case_when(
        !is.na(DATS) ~ DATS,
        !is.na(DATD) ~ DATD,
        TRUE ~ NA_Date_
      ),
    REMR = 
      case_when(
        !is.na(DATS) ~ REMS,
        !is.na(DATD) ~ REMD,
        TRUE ~ NA_character_
      ))%>% 
  select(-SOLD_1_Date,-SOLD_1_Remark,-DIED_1_Date,-DIED_1_Remark)
```


```{r}
df.master <- 
  comp_df %>%
  filter(!is.na(FCDAT)&!is.na(BDAT)&!is.na(FDAT))%>%
  filter((!nchar(FCDAT)< 8)&(!nchar(BDAT)< 8)&(!nchar(FDAT)<8))%>%
  mutate_at(vars(ID,RC), forcats::as_factor) %>% 
  mutate_at(vars(FCDAT,BDAT,FDAT), lubridate::mdy) %>%
  mutate_at(vars(ends_with("Date"), DATS, DATD,), lubridate::date)%>%   
  mutate_at(vars(FSTBF:PEAKM, DRYLG,LOG1,), as.numeric) %>%
  mutate(
    LCTGP = forcats::as_factor(case_when(LACT == 0 ~ 0,
                      LACT == 1 ~ 1,
                      LACT == 2 ~ 2,
                      LACT >= 3 ~ 3)),
    FRESH_MONTH = format_ISO8601(FDAT, precision = "ym"),
    DIM = ifelse(is.na(DATR),dairy_comp_extraction_date - FDAT,DATR - FDAT),
    `FRESH 372 TO 7` = ifelse(between(DIM, 7, 372), 1, 0),
    `FRESH 386 TO 21` = ifelse(between(DIM, 21, 386), 1, 0),
    `FRESH 425 TO 60` = ifelse(between(DIM, 60, 425), 1, 0),
    
    BIRTH_DATE = BDAT,
    `AGE_AT_CALVING_(MONTHS)` = interval(BIRTH_DATE, FDAT) %/% months(1),
    `AGE_AT_CALVING_1ST_LACT_(MONTHS)` = interval(BIRTH_DATE, FCDAT) %/% months(1), 
    DDRY = ifelse(LACT == 1,NA,DDRY),
    ABORT = ifelse(PDCC < 260, 1, 0),
    PDIM = ifelse(LACT == 1,NA,PDIM),
    
    #calving variables
    `CALVING_EASE_>=2` = ifelse(EASE >= 2, 1, 0),
    `CALVING_EASE_>=3` = ifelse(EASE >= 3, 1, 0),
    CNUM = ifelse((CNUM == 0 & EASE >0),NA,CNUM),
    TWINS = ifelse(CNUM > 1, 1, ifelse(CNUM == 1,0,NA)),
    STILLBIRTH = ifelse(str_detect(CLIVE, "D"), 1, 0),
    CALF_SEX = CSEX,
    MALE_CALF = ifelse(str_detect(CSEX, "M"), 1, 0),
    
    #generate Fat protein ratio
    FPR = FSTBF/FSTPR,
    FPR1.4 = ifelse(FPR > 1.4, 1, 0),
    
    #sold
    SOLD = ifelse(!is.na(DATS), 1, 0),
    SOLD_DIM = DATS - FDAT,
    `SOLD<=60` = ifelse(!is.na(DATS), ifelse(SOLD_DIM <= 60, 1, 0), 0),
    # died
    DIED = ifelse(!is.na(DATD), 1, 0),
    DIED_DIM = DATD - FDAT,
    `DIED<=60` = ifelse(!is.na(DATD),ifelse(DIED_DIM <= 60, 1, 0), 0),
    # removed
    REMVD = ifelse(!is.na(DATR), 1, 0),
    REMVD_DIM = DATR - FDAT,
    `REMVD<=60` = ifelse(!is.na(DATR),ifelse(REMVD_DIM <= 60, 1, 0), 0),
    #milk fever
    MLK_FVR = ifelse(!is.na(MF_1_Date), 1, 0),
    MLK_FVR_DIM = MF_1_Date - FDAT,
    `MLK_FVR<=7` = ifelse(!is.na(MF_1_Date), ifelse(MLK_FVR_DIM <= 7, 1, 0), 0),
    #retained placenta
    RP = ifelse(!is.na(RP_1_Date), 1, 0),
    RP_DIM = RP_1_Date - FDAT,
    `RP<=7` = ifelse(!is.na(RP_1_Date),ifelse(RP_DIM <= 7, 1, 0), 0),
    #metritis
    METR = ifelse(!is.na(METR_1_Date), 1, 0),
    METR_DIM = METR_1_Date - FDAT,
    `METR<=21` = ifelse(!is.na(METR_1_Date), ifelse(METR_DIM <= 21, 1, 0), 0),
    #ketosis
    KET = ifelse(!is.na(KETOSIS_1_Date), 1, 0),
    KET_DIM = KETOSIS_1_Date - FDAT,
    `KET<=60` = ifelse(!is.na(KETOSIS_1_Date), ifelse(KET_DIM <= 60, 1, 0), 0),
    #da
    DA = ifelse(!is.na(DA_1_Date), 1, 0),
    DA_DIM = DA_1_Date - FDAT,
    `DA<=60` = ifelse(!is.na(DA_1_Date), ifelse(DA_DIM <= 60, 1, 0), 0),
    #pneumonia
    PNEU = ifelse(!is.na(PNEU_1_Date), 1, 0),
    PNEU_DIM = PNEU_1_Date - FDAT,
    `PNEU<=60` = ifelse(!is.na(PNEU_1_Date),ifelse(PNEU_DIM <= 60, 1, 0), 0),
    #Diarrhea
    DIARR = ifelse(!is.na(DIARHEA_1_Date), 1, 0),
    DIARR_DIM = DIARHEA_1_Date - FDAT,
    `DIARR<=60` = ifelse(!is.na(DIARHEA_1_Date),ifelse(DIARR_DIM <= 60, 1, 0), 0),
    #lame
    LAME = ifelse(!is.na(LAME_1_Date), 1, 0),
    LAME_DIM = LAME_1_Date - FDAT,
    `LAME<=60` = ifelse(!is.na(LAME_1_Date), ifelse(LAME_DIM <= 60, 1, 0), 0),
    #Foot trim
    FTRM = ifelse(!is.na(FOOTRIM_1_Date), 1, 0),
    FTRM_DIM = FOOTRIM_1_Date - FDAT,
    `FTRM<=60` = ifelse(!is.na(FOOTRIM_1_Date), ifelse(FTRM_DIM <= 60, 1, 0), 0),
    #mastitis
    MAST = ifelse(!is.na(MAST_1_Date), 1, 0),
    MAST_DIM = MAST_1_Date - FDAT,
    `MAST<=60` = ifelse(!is.na(MAST_1_Date), ifelse(MAST_DIM <= 60, 1, 0), 0),
    #ILLMISC
    ILLMISC = ifelse(!is.na(ILLMISC_1_Date), 1, 0),
    ILLMISC_DIM = ILLMISC_1_Date - FDAT,
    `ILLMISC<=60` = ifelse(ILLMISC_DIM <= 60, 1, 0),
    `ILLMISC<=60` = ifelse(!is.na(ILLMISC_1_Date),ifelse(ILLMISC_DIM <= 60, 1, 0), 0),
  ) %>% 
  write_csv(paste(output_file_header,'all_events_master.csv',sep = '_'))

```


```{r}
df.master.last.lact <- 
  df.master %>% 
  group_by(ID) %>% 
  slice_max(LACT) %>% 
  ungroup() %>%
  write_csv(paste(output_file_header,'master_last_lact.csv',sep = '_'))

```







